# ==============================================================================
# CONFIG NAME: haproxy.cfg (UPDATED)
# DESCRIPTION: Load Balancer Konfigurasi (Round Robin & Fixed Redirect)
# AUTHOR     : Angga Alfiansah
# ==============================================================================

global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # Keamanan SSL
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s

# --- FRONTEND CONFIGURATION ---
frontend www_frontend
    bind *:80
    
    # Menggunakan 'location' untuk mengarahkan ke port spesifik 4435 secara eksplisit
    acl is_barat hdr(host) -i barat.sevima.site
    http-request redirect location https://barat.sevima.site:4435%[path] code 301 if is_barat
    
    # Pastikan path ini sesuai dengan tempat Mas menyimpan file gabungan .pem
    bind *:443 ssl crt /root/ca/www.sevima.site.pem
    
    mode http
    default_backend web_servers

# --- BACKEND CONFIGURATION ---
backend web_servers
    mode http
    # Algoritma Round Robin (Soal D)
    balance roundrobin
    
    # Health Check agar tidak mengirim trafik ke server yang 'fail'
    option httpchk
    http-check connect
    http-check send meth HEAD uri / hdr Host www.sevima.site
    
    # Tambahkan header X-Forwarded-For agar backend tahu IP asli client
    option forwardfor
    
    # Daftar Backend Server (Soal D)
    # Server Utara (Apache)
    server utara 127.0.0.1:8069 check
    # Server Timur (Nginx)
    server timur 127.0.0.1:8169 check
